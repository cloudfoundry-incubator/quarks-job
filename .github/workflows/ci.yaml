name: quarks-job-ci

on: [push, pull_request]
      
jobs:
  lint:
    runs-on: ubuntu-latest
          
    steps:
    - name: Set up Go 1.13.4
      uses: actions/setup-go@v2
      with:
        go-version: 1.13.4
    - uses: actions/checkout@v2
    - name: lint
      run: |
        curl -LO https://github.com/dominikh/go-tools/releases/download/2020.1.3/staticcheck_linux_amd64.tar.gz
        sudo tar xfz staticcheck_linux_amd64.tar.gz --strip-component 1 -C $GOPATH/bin staticcheck/staticcheck
        go get -u golang.org/x/lint/golint
        make lint

  unit-tests:
    needs: [lint]
    runs-on: ubuntu-latest
          
    steps:
    - name: Set up Go 1.13.4
      uses: actions/setup-go@v2
      with:
        go-version: 1.13.4
    - uses: actions/checkout@v2
    - name: Install ginkgo
      run: go install github.com/onsi/ginkgo/ginkgo
    - name: Run unit tests
      run: make test-unit
     
  integration-tests:
    needs: [unit-tests]
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        kubernetes_version: [1.14.10, 1.15.7]
    
    steps:
    - name: Set up Go 1.13.4
      uses: actions/setup-go@v2
      with:
        go-version: 1.13.4
    - name: Create k8s Kind Cluster
      uses: helm/kind-action@v1.0.0-rc.1
      with:
       version: ${{matrix.kubernetes_version}}
    - uses: actions/checkout@v2
    - name: Run integration tests
      run: USE_KIND=true make test-cluster
