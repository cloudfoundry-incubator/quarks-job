language: go

go:
- '1.13.4'

cache:
  directories:
    - $GOPATH/pkg/mod

services:
- docker

env:
  global:
    - GOPROXY="https://proxy.golang.org"
    - COVERAGE=true
  jobs:
    - KUBE=1.14.10
    - KUBE=1.15.7
    - KUBE=1.16.4
    - KUBE=1.17.0
    - KUBE=1.18.0

stages:
  - lint
  - unit
  - test

install:
  # Download go dev dependencies
  - export PATH=$PATH:$GOPATH/bin
  - go install github.com/onsi/ginkgo/ginkgo
  - go get github.com/mattn/goveralls
  - go get github.com/modocache/gover

before_script:
  # Download and install kubectl
  - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl && chmod +x kubectl && sudo mv kubectl /usr/local/bin/
  # Download and install KinD
  - curl -Lo kind https://github.com/kubernetes-sigs/kind/releases/download/v0.7.0/kind-linux-amd64 && chmod +x kind && sudo mv kind /usr/local/bin/
  # Create a new Kubernetes cluster using KinD
  - kind create cluster --image kindest/node:v$KUBE --name kind$KUBE --wait 240s
  - kubectl version
  # Download and install helm
  - export DESIRED_VERSION="v3.1.0"
  - curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 > get_helm.sh
  - chmod 700 get_helm.sh
  - sudo ./get_helm.sh
  # yes, heredocs are broken in before_script: https://travis-ci.community/t/multiline-commands-have-two-spaces-in-front-breaks-heredocs/2756
script:
  - USE_KIND="true" make test-cluster
  - make coverage

jobs:
  include:
    - stage: unit
      services: []
      before_script:
        - curl -LO https://github.com/dominikh/go-tools/releases/download/2020.1.3/staticcheck_linux_amd64.tar.gz
        - tar xfz staticcheck_linux_amd64.tar.gz --strip-component 1 -C $GOPATH/bin staticcheck/staticcheck
        - go get -u golang.org/x/lint/golint
      script: make lint
      name: lint
    - script: make test-unit coverage
      # do not inherit
      services: []
      before_script: []
      name: unit
      env: KUBE=none

    - stage: Publishing image
      if: branch = master
      # do not inherit
      install: []
      before_script: []
      script: echo "Publishing image"
      deploy:
        provider: script
        script: bash -c "make publish-image"
        skip_cleanup: true
        on:
          branch: master

    - stage: Publishing helm chart
      if: branch = master
      # do not inherit
      install: []
      script: echo "Publishing helm chart"
      before_deploy:
        - . bin/include/versioning
        - ./bin/build-helm
        - mkdir helm-charts
        - cp helm/quarks-job*.tgz helm-charts/
        - git tag -a $ARTIFACT_VERSION -m "tag $ARTIFACT_VERSION"
        - git push --quiet https://CFContainerizationBot:$GITHUB_TOKEN@github.com/cloudfoundry-incubator/quarks-job.git $ARTIFACT_VERSION > /dev/null 2>&1
        - export ARTIFACT_VERSION=$ARTIFACT_VERSION
      deploy:
        - provider: script
          script:
            git clone https://CFContainerizationBot:$GITHUB_TOKEN@github.com/cloudfoundry-incubator/quarks-helm.git ./updated/ &&
            cp helm-charts/quarks-job*.tgz updated/ &&
            ./bin/publish-helm-repo
          skip_cleanup: true
          on:
            branch: master
